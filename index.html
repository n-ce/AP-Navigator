<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AP Content Tour Guide (Alpine.js - via corsproxy.io corrected)</title>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        /* Minimal inline CSS for highlighting, since no external styles */
        li.selected {
            background-color: #e0e7ff; /* light indigo */
            font-weight: bold;
            color: #4c51bf; /* indigo */
        }
        details > summary {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <header>
        <h1>Acharya Prashant Content Tour Guide</h1>
        <p>Explore books and open articles directly.</p>
    </header>

    <main x-data="app()" x-init="init()">
        <p x-text="statusMessage" x-show="statusMessage"></p>

        <section>
            <h2>Books</h2>
            <div>
                <template x-for="book in books" :key="book.id">
                    <details @toggle="if($el.open && !book._chaptersLoaded) fetchChapters(book)">
                        <summary x-text="book.title.english"></summary>
                        <ul>
                            <template x-for="chapter in book.chapters" :key="chapter.id">
                                <li @click.stop="searchArticleAndOpen(chapter.title, $el)" :class="{ 'selected': selectedChapter === chapter.title }" x-text="chapter.title"></li>
                            </template>
                            <li x-show="!book.chapters || book.chapters.length === 0">No chapters found for this book.</li>
                        </ul>
                    </details>
                </template>
                <p x-show="!books.length && !statusMessage">No books available.</p>
            </div>
        </section>
    </main>

    <script>
        // Alpine.js application logic
        function app() {
            return {
                // Reactive data properties
                books: [],
                statusMessage: 'Loading content...',
                selectedChapter: null, // To track the currently selected chapter for highlighting

                // Initialization method
                init() {
                    this.fetchBooks();
                },

                // 1. Fetch Books
                fetchBooks() {
                    this.statusMessage = 'Loading books...';
                    // Corrected: Use ?url= as the query parameter for corsproxy.io
                    fetch('https://corsproxy.io/?url=https://acharyaprashant.org/api/v2/content/bk-ego?lf=0', {
                        headers: {
                            'X-Client-Type': 'web'
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        this.books = [data.content];
                        if (this.books.length > 0) {
                            this.books[0].chapters = [];
                            this.books[0]._chaptersLoaded = false;
                        }
                        this.statusMessage = '';
                    })
                    .catch(error => {
                        console.error('Failed to fetch books:', error);
                        this.statusMessage = 'Error: Could not load books. Check CORS or network: ' + error.message;
                    });
                },

                // 2. Fetch/Load Chapters for a specific book's details element
                fetchChapters(book) {
                    if (!book._chaptersLoaded) {
                        this.statusMessage = `Loading chapters for "${book.title.english}"...`;
                        book.chapters = book.enumMask.value.subContents["1"].value.chapters;
                        book._chaptersLoaded = true;
                        this.statusMessage = '';
                    }
                },

                // 3. Search for Articles and Directly Open the First Result
                searchArticleAndOpen(query, clickedElement) {
                    this.statusMessage = `Searching for article related to "${query}"...`;
                    this.selectedChapter = query;

                    // Corrected: Use ?url= as the query parameter for corsproxy.io
                    fetch('https://corsproxy.io/?url=https://acharyaprashant.org/api/v2/content/search', {
                        method: 'POST',
                        headers: {
                            'X-Client-Type': 'web',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            q: query,
                            sft: false,
                            limitTypes: [1],
                            offset: '',
                            lf: 2,
                            limit: 1,
                            forceSearchTerm: false
                        })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.searchedContents && data.searchedContents.data.length > 0) {
                            const firstResult = data.searchedContents.data[0];
                            const articleUrl = 'https://acharyaprashant.org/en/content/article/' + firstResult.meta.seoSlug;
                            window.open(articleUrl, '_blank');
                            this.statusMessage = `Opened: "${firstResult.meta.title.english || firstResult.meta.title.hindi}"`;
                        } else {
                            this.statusMessage = 'No article found for "' + query + '".';
                        }
                    })
                    .catch(error => {
                        console.error('Failed to search or open article:', error);
                        this.statusMessage = 'Error: Could not search or open article: ' + error.message;
                    });
                }
            };
        }
    </script>
</body>
</html>
