<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-38">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AP Content Tour Guide (Direct Open)</title>
</head>
<body>
    <header>
        <h1>Acharya Prashant Content Tour Guide</h1>
        <p>Explore books and open articles directly.</p>
    </header>
    <main>
        <p>Loading content...</p>
        <section>
            <h2>Books</h2>
            <div></div>
        </section>
        </main>
    <script>
        const mainElement = document.body.children[1];
        // Now only statusMessageP and booksSection are direct children of main
        const [statusMessageP, booksSection] = mainElement.children;
        const booksDetailsContainer = booksSection.children[1];

        // searchResultsList and noSearchResultsMessageP are removed as their parent section is gone

        function setStatusMessage(message) {
            statusMessageP.textContent = message;
        }

        function hideAllMessages() {
            statusMessageP.textContent = '';
            // noSearchResultsMessageP is removed, so no need to hide it
        }

        // 1. Fetch and List Books as <details> elements
        function fetchBooks() {
            setStatusMessage('Loading books...');
            hideAllMessages();
            booksDetailsContainer.innerHTML = '';

            fetch('https://acharyaprashant.org/api/v2/content/bk-ego?lf=0', {
                headers: {
                    'X-Client-Type': 'web'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                setStatusMessage('');
                const book = data.content;
                if (book && book.title && book.title.english) {
                    const detailsElement = document.createElement('details');
                    const summaryElement = document.createElement('summary');
                    const chaptersList = document.createElement('ul');
                    summaryElement.textContent = book.title.english;
                    detailsElement.appendChild(summaryElement);
                    detailsElement.appendChild(chaptersList);
                    detailsElement._bookData = book;
                    detailsElement._chaptersLoaded = false;
                    detailsElement.addEventListener('toggle', function() {
                        if (this.open && !this._chaptersLoaded) {
                            fetchChaptersForDetails(this);
                        }
                    });
                    booksDetailsContainer.appendChild(detailsElement);
                } else {
                    setStatusMessage('Error: No book data found.');
                }
            })
            .catch(error => {
                console.error('Failed to fetch books:', error);
                setStatusMessage('Error: Could not load books. Check CORS or network: ' + error.message);
            });
        }

        // 2. Fetch and Display Chapters INSIDE a specific <details> element
        function fetchChaptersForDetails(detailsElement) {
            hideAllMessages();
            const book = detailsElement._bookData;
            const chaptersList = detailsElement.querySelector('ul');

            if (!chaptersList) {
                setStatusMessage('Error: Chapters list element not found within details.');
                return;
            }
            chaptersList.innerHTML = '';
            setStatusMessage(`Loading chapters for "${book.title.english}"...`);

            try {
                const chapters = book.enumMask.value.subContents["1"].value.chapters;
                if (chapters && chapters.length > 0) {
                    chapters.forEach(chapter => {
                        const listItem = document.createElement('li');
                        listItem.textContent = chapter.title;
                        listItem._chapterTitle = chapter.title;
                        listItem.addEventListener('click', function(event) {
                            event.stopPropagation(); // Prevent the details element from closing
                            searchArticleAndOpen(this._chapterTitle, event.currentTarget); // Renamed function
                        });
                        chaptersList.appendChild(listItem);
                    });
                    detailsElement._chaptersLoaded = true;
                    setStatusMessage('');
                } else {
                    const listItem = document.createElement('li');
                    listItem.textContent = 'No chapters found for this book.';
                    chaptersList.appendChild(listItem);
                    detailsElement._chaptersLoaded = true;
                    setStatusMessage('');
                }
            } catch (error) {
                console.error('Failed to process chapters:', error);
                setStatusMessage('Error: Could not display chapters: ' + error.message);
            }
        }

        // 3. Search for Articles and Directly Open the First Result
        function searchArticleAndOpen(query, clickedElement) { // Renamed function
            hideAllMessages();
            setStatusMessage('Searching for article related to "' + query + '"...');

            // Remove 'selected' class from all chapter items across all books
            document.querySelectorAll('details ul li').forEach(item => {
                item.classList.remove('selected');
            });
            // Add 'selected' class to the clicked chapter item
            if (clickedElement) {
                clickedElement.classList.add('selected');
            }

            fetch('https://acharyaprashant.org/api/v2/content/search', {
                method: 'POST',
                headers: {
                    'X-Client-Type': 'web',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    q: query,
                    sft: false,
                    limitTypes: [1],
                    offset: '',
                    lf: 2,
                    limit: 1, // Only need 1 result now
                    forceSearchTerm: false
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                setStatusMessage('');
                const searchResults = data.searchedContents.data;

                if (searchResults && searchResults.length > 0) {
                    const firstResult = searchResults[0];
                    const articleUrl = 'https://acharyaprashant.org/en/content/article/' + firstResult.meta.seoSlug;
                    window.open(articleUrl, '_blank');
                    setStatusMessage(`Opened: "${firstResult.meta.title.english || firstResult.meta.title.hindi}"`);
                } else {
                    setStatusMessage('No article found for "' + query + '".');
                }
            })
            .catch(error => {
                console.error('Failed to search or open article:', error);
                setStatusMessage('Error: Could not search or open article: ' + error.message);
            });
        }
        fetchBooks();
    </script>
</body>
</html>
